name: Release Flatpak

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

env:
  APP_ID: com.nullide.app

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: bilelmoussaoui/flatpak-github-actions:freedesktop-24.08
      options: --privileged

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build tools
        run: |
          dnf install -y gcc g++ make python3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Build Flatpak
        uses: flatpak/flatpak-github-actions/flatpak-builder@v6
        with:
          bundle: Null-IDE-${{ github.ref_name }}.flatpak
          manifest-path: com.nullide.app.json
          upload-artifact: false

      - name: Create OSTree Repository
        run: |
          # List what's in the repo directory
          ls -la repo/ || ls -la .flatpak-builder/repo/ || true

          # Find the actual repo location
          if [ -d "repo" ]; then
            SRC_REPO="repo"
          elif [ -d ".flatpak-builder/repo" ]; then
            SRC_REPO=".flatpak-builder/repo"
          else
            echo "Could not find flatpak repo"
            exit 1
          fi

          # List refs in the source repo
          flatpak list --user --show-details || true
          ostree refs --repo=$SRC_REPO || true

          # Create OSTree repository for GitHub Pages
          mkdir -p pages/repo
          ostree init --mode=archive-z2 --repo=pages/repo

          # Copy all refs from source repo
          for ref in $(ostree refs --repo=$SRC_REPO); do
            echo "Copying ref: $ref"
            ostree pull-local --repo=pages/repo $SRC_REPO $ref || true
          done

          # Update repository metadata
          flatpak build-update-repo pages/repo --title="Null IDE Repository"

          cat > pages/nullide.flatpakrepo << 'EOF'
          [Flatpak Repo]
          Title=Null IDE
          Url=https://4fqr.github.io/null-ide/repo
          Homepage=https://github.com/4fqr/null-ide
          Comment=The Ultimate Hacker's Code Editor & Security Toolkit
          Description=Professional IDE with 60+ security testing tools
          Icon=https://raw.githubusercontent.com/4fqr/null-ide/main/null-ide.png
          EOF

          cat > pages/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Null IDE Flatpak Repository</title>
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; background: #1a1a2e; color: #eee; }
              h1 { color: #00d9ff; }
              code { background: #16213e; padding: 2px 6px; border-radius: 4px; }
              pre { background: #16213e; padding: 15px; border-radius: 8px; overflow-x: auto; }
              .step { margin: 20px 0; }
              a { color: #00d9ff; }
            </style>
          </head>
          <body>
            <h1>Null IDE Flatpak Repository</h1>
            <p>Professional IDE with 60+ security testing tools.</p>
            <div class="step">
              <h3>1. Add the repository:</h3>
              <pre><code>flatpak remote-add --user --if-not-exists nullide https://4fqr.github.io/null-ide/repo</code></pre>
            </div>
            <div class="step">
              <h3>2. Install Null IDE:</h3>
              <pre><code>flatpak install --user nullide com.nullide.app</code></pre>
            </div>
            <div class="step">
              <h3>3. Update:</h3>
              <pre><code>flatpak update com.nullide.app</code></pre>
            </div>
            <p><a href="https://github.com/4fqr/null-ide">GitHub Repository</a></p>
          </body>
          </html>
          EOF

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: pages

      - name: Upload bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-bundle
          path: Null-IDE-${{ github.ref_name }}.flatpak
          retention-days: 1

  deploy-pages:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  release:
    needs: [build, deploy-pages]
    runs-on: ubuntu-latest

    steps:
      - name: Download bundle artifact
        uses: actions/download-artifact@v4
        with:
          name: flatpak-bundle

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Null IDE ${{ github.ref_name }}
          body: |
            ## Null IDE ${{ steps.version.outputs.VERSION }}

            ### Installation

            **Add the repository (one-time setup):**
            ```bash
            flatpak remote-add --user --if-not-exists nullide https://4fqr.github.io/null-ide/repo
            ```

            **Install:**
            ```bash
            flatpak install --user nullide com.nullide.app
            ```

            **Update to this version:**
            ```bash
            flatpak update com.nullide.app
            ```

            ### What's Changed
            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.
          files: |
            Null-IDE-${{ github.ref_name }}.flatpak
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
